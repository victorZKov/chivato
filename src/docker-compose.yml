# ==========================================
# Chivato - Docker Compose Development
# ==========================================
# Usage:
#   docker compose up          - Start all services
#   docker compose up -d       - Start in background
#   docker compose down        - Stop all services
#   docker compose logs -f     - View logs
#   docker compose build       - Rebuild images
# ==========================================

services:
  # ==========================================
  # Azurite - Azure Storage Emulator
  # ==========================================
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: chivato-azurite
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    volumes:
      - azurite-data:/data
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:10002/', (r) => process.exit(r.statusCode === 400 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # API - ASP.NET Core Web API
  # ==========================================
  api:
    build:
      context: .
      dockerfile: api/Chivato.Api/Dockerfile
    container_name: chivato-api
    ports:
      - "7071:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - StorageConnectionString=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
      - KeyVaultUrl=https://local-keyvault.vault.azure.net/
      - ServiceBusConnectionString=${SERVICEBUS_CONNECTION_STRING:-}
      - AzureAd__TenantId=${AZURE_TENANT_ID:-c519d036-58f9-406a-bba0-1fdddea8d88e}
      - AzureAd__ClientId=${AZURE_CLIENT_ID:-6053ddd0-9d36-4d2d-9675-db211cc7bb03}
      - Cors__AllowedOrigins=http://localhost:5280
    depends_on:
      azurite:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Worker - Drift Analysis Processor (Optional)
  # ==========================================
  # Uncomment when Service Bus is configured
  # worker:
  #   build:
  #     context: .
  #     dockerfile: worker/Chivato.Worker/Dockerfile
  #   container_name: chivato-worker
  #   environment:
  #     - StorageConnectionString=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
  #     - KeyVaultUrl=https://local-keyvault.vault.azure.net/
  #     - ServiceBusConnectionString=${SERVICEBUS_CONNECTION_STRING}
  #     - SignalRConnectionString=${SIGNALR_CONNECTION_STRING:-}
  #   depends_on:
  #     azurite:
  #       condition: service_healthy
  #     api:
  #       condition: service_healthy

  # ==========================================
  # UI - Vite React Frontend (Development)
  # ==========================================
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
      target: development
    container_name: chivato-ui
    ports:
      - "5280:5280"
    environment:
      - VITE_ENTRA_CLIENT_ID=${AZURE_CLIENT_ID:-6053ddd0-9d36-4d2d-9675-db211cc7bb03}
      - VITE_ENTRA_TENANT_ID=${AZURE_TENANT_ID:-c519d036-58f9-406a-bba0-1fdddea8d88e}
      - VITE_API_URL=http://localhost:7071/api
      - VITE_REDIRECT_URI=http://localhost:5280/
    volumes:
      - ./ui/src:/app/src:ro
      - ./ui/public:/app/public:ro
      - ./ui/index.html:/app/index.html:ro
    depends_on:
      - api

# ==========================================
# Volumes
# ==========================================
volumes:
  azurite-data:
    name: chivato-azurite-data

# ==========================================
# Networks
# ==========================================
networks:
  default:
    name: chivato-network
